
<!DOCTYPE html>
<html>
	<head>
		<title>T800-Controller</title>
	</head>
	<body>
		<button id="discoverBluetoothBtn">Discover T800 Device</button><button id="diconnectBluetoothBtn">Disconnect</button><button id="reconnectBluetoothBtn">Reconnect</button>
		<br><br>
		<label for="speech-commands">Choose Speech command:</label><br>
		<select id="speech-commands" name="speech-commands" onchange="getSpeechCommand()">
			<optgroup label = "T1">
				<option value="sc" selected="selected">Sarah Connor</option>
				<option value="fya">Fuck you asshole</option>
				<option value="ibb">Ill be back</option>
				<option value="ycgttmn">Your clothes give them to me now</option>
			  	<option value="ncr">Nothing clean right</option>
				<option value="45lswls">45 Long Slide with Lazer sighting</option>
				<option value="go">Get out</option>				
			  	<option value="u9">Uzi 9mm</option>
		  	</optgroup>
		  	<optgroup label = "T2">
		  		<option value="alvb">Asta La Vista Baby</option>
				<option value="np">No problemo</option>
				<option value="ibb">Ill be back</option>
				<option value="tm">Trust me</option>
			  	<option value="ltmvc">Listen to me very carefully</option>
				<option value="iaat">I am a Terminator</option>
				<option value="csm1">Cyberdyne systems Model 101</option>				
			  	<option value="inycybaym">I need your clothes your boots and your motorcycle</option>
				<option value="toommp">Thats one of my mission parameters</option>
				<option value="iknwyc">I now know why you cry</option>
				<option value="hl">He'll live</option>
			  	<option value="cd">Chillout dickwad</option>
				<option value="4cwmiywtl">Come with me if you want to live</option>
		  	</optgroup>
		  	<optgroup label = "T3">
		  		<option value="iaam">I am a machine</option>
				<option value="yat">You are Terminated</option>
				<option value="ddt">Don't do that</option>
			</optgroup> 
		</select>
		<p id="speechCommandSelection">You selected: Sarah Connor</p>
		<button id="sendSpeechCommandBtn">Send</button>
		<br><br>
		<label for="movement-commands">Choose Movement command:</label><br>
		<select id="movement-commands" name="movement-commands" onchange="getMovementCommand()">
			<option value="activate" selected="selected">Activate T800</option>
			<option value="deactivate">Deactivate T800</option>
			<option value="randomHeadlr">Random Head left to right</option>
			<option value="randomHeadud">Random Head up and down</option>
			<option value="randomHeadfr">Random Head full range</option>				
		  	<option value="epic_mode_1">T1 Epic Mode</option>
		  	<option value="epic_mode_2">T2 Epic Mode</option>
		</select>
		<br>
		<p id="movementCommandSelection">You selected: Activate T800</p>
		<button id="sendActionCommandBtn">Send</button>
	</body>
	<script>

		const bluetoothName = 'DSD TECH';
		const bluetoothUUIDservice = '0000ffe0-0000-1000-8000-00805f9b34fb';
		const bluetoothUUIDcharacteristic = '0000ffe1-0000-1000-8000-00805f9b34fb';

		var command = "";
		var myCharateristic;
		var bluetoothDevice;
		
		document.getElementById("discoverBluetoothBtn").addEventListener('click', function() {
			bluetoothDevice = null;
		  	navigator.bluetooth.requestDevice({
		    filters: [{
			    name: bluetoothName,
			    services: [bluetoothUUIDservice]
			  }]
		  	})
		  	.then(device => {
		  		bluetoothDevice = device;
		    	console.log('> Requested ' + device.name + ' (' + device.id + ')');
			    // Attempts to connect to remote GATT Server.
	  			return device.gatt.connect()
		  	})
		  	.then(server => {
			  	return server.getPrimaryService(bluetoothUUIDservice);
			})
			.then(service => {
			  	return service.getCharacteristic(bluetoothUUIDcharacteristic);
			})
			.then(characteristic => {
				myCharateristic = characteristic;
			 })
			.catch(error => {
			    logError(error);
	  		});

		});

		document.getElementById("sendSpeechCommandBtn").addEventListener('click', function() {
			sendCommand();
		});

		document.getElementById("sendActionCommandBtn").addEventListener('click', function() {
			sendCommand();
		});

		document.getElementById("diconnectBluetoothBtn").addEventListener('click', function() {
			disconnect();
		});

		document.getElementById("reconnectBluetoothBtn").addEventListener('click', function() {
			reconnect();
		});

		function connect() {
		  console.log('Connecting to Bluetooth Device...');
		  return bluetoothDevice.gatt.connect()
		  .then(server => {
		    console.log('> Bluetooth Device connected');
		  });
		}

		function disconnect() {
		  if (!bluetoothDevice) {
		    return;
		  }
		  console.log('Disconnecting from Bluetooth Device...');
		  if (bluetoothDevice.gatt.connected) {
		    bluetoothDevice.gatt.disconnect();
		  } else {
		    console.log('> Bluetooth Device is already disconnected');
		  }
		}

		function onDisconnected(event) {
		  // Object event.target is Bluetooth Device getting disconnected.
		  console.log('> Bluetooth Device disconnected');
		}

		function reconnect() {
		  if (!bluetoothDevice) {
		    return;
		  }
		  if (bluetoothDevice.gatt.connected) {
		    console.log('> Bluetooth Device is already connected');
		    return;
		  }
		  connect()
		  .catch(error => {
		    console.log('Argh! ' + error);
		  });
		}

		function sendCommand() {
			logCommand(command);
			var stringArray = str2ab(command);
			myCharateristic.writeValueWithoutResponse(stringArray);
		}

		function logCommand(command) {
			console.log('Seinding command: ' + command);
		}	

		function logError(error) {
			console.log('Error: ' + error);
		}

		function getSpeechCommand() {
			const commandSelection = document.getElementById("speech-commands")
		  	command = commandSelection.value
		  	document.getElementById("speechCommandSelection").innerHTML = "You selected: " + commandSelection.options[commandSelection.selectedIndex].text;
		}

		function getMovementCommand() {
			const commandSelection = document.getElementById("movement-commands")
		  	command = commandSelection.value
		  	document.getElementById("movementCommandSelection").innerHTML = "You selected: " + commandSelection.options[commandSelection.selectedIndex].text;
		}

		function str2ab(str) {
		  var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
		  var bufView = new Uint8Array(buf);
		  for (var i=0, strLen=str.length; i < strLen; i++) {
		    bufView[i] = str.charCodeAt(i);
		  }
		  return buf;
		}
	</script>
</html>